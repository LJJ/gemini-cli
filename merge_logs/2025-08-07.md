# Merge Log - 2025-08-07

## 问题描述
Merge 了 gemini-cli 开源库的最新代码后，构建失败，出现多个 TypeScript 编译错误。

## 解决的问题

### 1. 重复依赖问题
**错误信息**：
```
▲ [WARNING] Duplicate key "@google/genai" in object literal [duplicate-object-key]
packages/cli/package.json:33:4: "@google/genai": "1.9.0"
packages/cli/package.json:31:4: "@google/genai": "1.8.0"
```

**解决方案**：
- 修复了 `packages/cli/package.json` 中重复的 `@google/genai` 依赖
- 保留了较新的版本 1.9.0，删除了重复的 1.8.0 版本

**修改文件**：
- `packages/cli/package.json`

### 2. 缺失依赖问题
**错误信息**：
```
✘ [ERROR] Could not resolve "fast-uri"
packages/core/node_modules/ajv/dist/runtime/uri.js:3:20: const uri = require("fast-uri");
```

**解决方案**：
- 在 `packages/core/package.json` 中添加了 `"fast-uri": "^2.0.0"` 依赖
- `ajv` 需要 `fast-uri` 作为依赖，但该包没有被安装

**修改文件**：
- `packages/core/package.json`

### 3. 方法调用错误
**错误信息**：
```
error TS2551: Property 'setContentGeneratorConfig' does not exist on type 'Config'
```

**解决方案**：
- 为 `Config` 类添加了 `setContentGeneratorConfig` 方法
- 恢复了 `AuthService` 中的原始配置设置逻辑
- 确保配置同步正常工作

**修改文件**：
- `packages/core/src/config/config.ts`
- `packages/core/src/server/auth/AuthService.ts`

### 4. 接口属性错误
**错误信息**：
```
error TS2353: Object literal may only specify known properties, and 'approvalMode' does not exist in type 'CoreToolSchedulerOptions'
```

**解决方案**：
- 移除了 `ToolOrchestrator` 中不存在的 `approvalMode` 属性
- 添加了必需的 `onEditorClose` 回调函数
- 更新了 `CoreToolSchedulerOptions` 接口的使用

**修改文件**：
- `packages/core/src/server/tools/ToolOrchestrator.ts`

### 5. 模型支持列表不完整
**错误信息**：
```
Invalid model name. Valid models: gemini-2.5-pro, gemini-2.5-flash
```

**解决方案**：
- 更新了 `SUPPORTED_MODELS` 数组，添加了 `gemini-2.5-flash-lite`
- 确保所有在 `models.ts` 中定义的模型都在支持列表中

**修改文件**：
- `packages/core/src/server/core/GeminiService.ts`

### 6. iOS 客户端模型显示问题
**问题描述**：
iOS 端的 `ModelInfo` 结构体中 `displayName` 逻辑不完整，只处理了部分模型。

**解决方案**：
- 添加了完整的模型显示名称映射
- 支持 `gemini-2.5-pro`、`gemini-2.5-flash`、`gemini-2.5-flash-lite` 的显示名称

**修改文件**：
- `GeminiForMac/GeminiForMac/Modules/Input/MessageInputModel.swift`

### 7. 工具注册表初始化错误
**错误信息**：
```
TypeError: Cannot read properties of undefined (reading 'clear')
at ToolRegistry.discoverAllTools
```

**问题描述**：
`promptRegistry` 在 `discoverAllTools()` 调用时未初始化，导致 `clear()` 方法调用失败。

**解决方案**：
- 在 `createToolRegistry()` 方法中确保 `promptRegistry` 被正确初始化
- 添加了初始化检查逻辑

**修改文件**：
- `packages/core/src/config/config.ts`

## 影响的功能
- ✅ 模型切换功能恢复正常
- ✅ 聊天功能正常工作
- ✅ 工具调用功能正常
- ✅ iOS 客户端模型显示正确
- ✅ 配置同步正常工作

## 测试结果
- ✅ `npm run build` 成功
- ✅ `npm run bundle` 成功
- ✅ 模型切换功能正常
- ✅ 聊天功能正常

## 注意事项
1. 确保在 merge 上游代码时检查依赖冲突
2. 注意接口变更，及时更新相关代码
3. 保持 iOS 客户端与服务器端的模型支持一致性
4. 检查初始化顺序，确保依赖项正确初始化

## 相关文件
- `packages/cli/package.json`
- `packages/core/package.json`
- `packages/core/src/config/config.ts`
- `packages/core/src/server/auth/AuthService.ts`
- `packages/core/src/server/tools/ToolOrchestrator.ts`
- `packages/core/src/server/core/GeminiService.ts`
- `GeminiForMac/GeminiForMac/Modules/Input/MessageInputModel.swift` 